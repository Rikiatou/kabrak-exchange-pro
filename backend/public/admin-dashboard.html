<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KABRAK Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --green: #0B6E4F; --gold: #e8a020; --dark: #071a12; --darker: #050f0b; --gray-900: #111827; --gray-800: #1f2937; --gray-700: #374151; --gray-600: #4b5563; --gray-500: #6b7280; --gray-400: #9ca3af; --gray-200: #e5e7eb; }
        html, body { height: 100%; }
        body { background: var(--dark); font-family: Inter, system-ui, -apple-system, sans-serif; color: var(--gray-200); font-size: 14px; line-height: 1.5; }

        /* ── Layout ── */
        #loginScreen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 16px; }
        .login-card { background: var(--gray-800); border: 1px solid var(--gray-700); border-radius: 16px; padding: 32px; width: 100%; max-width: 380px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .login-logo { width: 64px; height: 64px; background: #064e3b; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; }
        .login-logo i { font-size: 24px; color: #34d399; }
        .login-title { text-align: center; color: var(--gold); font-size: 20px; font-weight: 700; }
        .login-sub { text-align: center; color: var(--gray-400); font-size: 13px; margin-top: 4px; margin-bottom: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; color: var(--gray-400); margin-bottom: 6px; }
        .form-input { width: 100%; padding: 12px; background: var(--gray-700); border: 1px solid var(--gray-600); border-radius: 8px; color: #fff; font-size: 14px; outline: none; transition: border-color .2s; }
        .form-input:focus { border-color: var(--green); }
        .btn-primary { width: 100%; padding: 12px; background: var(--green); color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: opacity .2s; }
        .btn-primary:hover { opacity: .9; }
        .btn-primary:disabled { opacity: .6; cursor: not-allowed; }
        .login-error { color: #f87171; font-size: 13px; text-align: center; margin-top: 10px; display: none; }

        /* ── Dashboard layout ── */
        #dashboardScreen { display: flex; min-height: 100vh; }
        .sidebar { width: 240px; min-height: 100vh; background: var(--darker); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; z-index: 40; transition: width .2s; border-right: 1px solid #0d1f16; }
        .sidebar.collapsed { width: 64px; }
        .sidebar.collapsed .nav-label, .sidebar.collapsed .logo-text, .sidebar.collapsed .user-info { display: none; }
        .main-content { margin-left: 240px; flex: 1; min-height: 100vh; transition: margin-left .2s; }
        .main-content.expanded { margin-left: 64px; }

        /* ── Sidebar ── */
        .sidebar-header { padding: 16px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #0d1f16; }
        .sidebar-logo-icon { width: 32px; height: 32px; background: var(--green); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .sidebar-logo-icon i { color: #fff; font-size: 13px; }
        .logo-text { color: var(--gold); font-weight: 700; font-size: 13px; white-space: nowrap; }
        .sidebar-nav { flex: 1; padding: 12px 8px; display: flex; flex-direction: column; gap: 4px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: var(--gray-400); font-size: 13px; text-decoration: none; transition: background .15s, color .15s; white-space: nowrap; border: none; background: none; width: 100%; text-align: left; }
        .nav-item:hover { background: var(--gray-800); color: var(--gray-200); }
        .nav-item.active { background: var(--green); color: #fff; }
        .nav-item.active i, .nav-item.active span { color: #fff; }
        .nav-item i { width: 18px; text-align: center; flex-shrink: 0; }
        .sidebar-footer { padding: 16px; border-top: 1px solid #0d1f16; }
        .user-row { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; background: #064e3b; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .user-avatar i { color: #34d399; font-size: 12px; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-size: 12px; font-weight: 600; color: var(--gray-200); }
        .btn-logout { font-size: 11px; color: #f87171; background: none; border: none; cursor: pointer; padding: 0; text-align: left; }
        .btn-logout:hover { color: #fca5a5; }
        .pending-badge { margin-left: auto; background: #d97706; color: #fff; font-size: 11px; padding: 1px 7px; border-radius: 999px; display: none; }

        /* ── Top bar ── */
        .topbar { position: sticky; top: 0; z-index: 30; background: rgba(7,26,18,0.95); backdrop-filter: blur(8px); border-bottom: 1px solid #0d1f16; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
        .topbar-left { display: flex; align-items: center; gap: 12px; }
        #pageTitle { color: #fff; font-size: 17px; font-weight: 700; }
        .topbar-right { display: flex; align-items: center; gap: 8px; }
        .btn-icon { background: none; border: none; color: var(--gray-400); cursor: pointer; padding: 7px; border-radius: 8px; font-size: 14px; transition: background .15s, color .15s; }
        .btn-icon:hover { background: var(--gray-800); color: #fff; }
        #lastRefresh { font-size: 11px; color: var(--gray-500); }

        /* ── Content ── */
        .page-content { padding: 24px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ── Stat cards ── */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: linear-gradient(135deg, #1a2e24, #0d1f16); border: 1px solid #1a3d2e; border-radius: 14px; padding: 18px; transition: border-color .2s, transform .2s; }
        .stat-card:hover { border-color: var(--green); transform: translateY(-2px); }
        .stat-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .stat-label { color: var(--gray-400); font-size: 12px; }
        .stat-value { color: #fff; font-size: 28px; font-weight: 800; line-height: 1; }
        .stat-sub { color: var(--gray-500); font-size: 12px; margin-top: 4px; }
        .stat-value.orange { color: #fb923c; }
        .stat-value.red { color: #f87171; }

        /* ── Panels ── */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
        .panel { background: var(--gray-800); border: 1px solid var(--gray-700); border-radius: 14px; padding: 20px; }
        .panel-title { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 16px; }
        .panel-title i { margin-right: 8px; }
        .activity-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; margin-bottom: 6px; }
        .activity-item:hover { background: rgba(255,255,255,0.04); }
        .activity-avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; background: #064e3b; color: #34d399; }
        .activity-info { flex: 1; min-width: 0; }
        .activity-name { font-size: 13px; font-weight: 500; color: var(--gray-200); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .activity-meta { font-size: 11px; color: var(--gray-500); }
        .activity-date { font-size: 11px; color: var(--gray-500); flex-shrink: 0; }

        /* ── Toolbar ── */
        .toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 16px; }
        .filter-btn { padding: 6px 14px; border-radius: 8px; border: none; background: var(--gray-700); color: var(--gray-400); font-size: 13px; cursor: pointer; transition: background .15s, color .15s; }
        .filter-btn:hover { background: var(--gray-600); color: #fff; }
        .filter-btn.active { background: var(--green); color: #fff; }
        .search-input { margin-left: auto; padding: 6px 12px; background: var(--gray-700); border: 1px solid var(--gray-600); border-radius: 8px; color: #fff; font-size: 13px; outline: none; width: 200px; }
        .search-input:focus { border-color: var(--green); }
        .btn-create { padding: 6px 14px; border-radius: 8px; border: none; background: var(--green); color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; }
        .btn-create:hover { opacity: .9; }

        /* ── Tables ── */
        .table-wrap { background: var(--gray-800); border: 1px solid var(--gray-700); border-radius: 14px; overflow: hidden; }
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; color: var(--gray-200); }
        thead tr { border-bottom: 1px solid var(--gray-700); }
        th { padding: 10px 14px; text-align: left; font-size: 11px; font-weight: 600; color: var(--gray-400); text-transform: uppercase; letter-spacing: .05em; white-space: nowrap; }
        th.center, td.center { text-align: center; }
        td { padding: 12px 14px; border-top: 1px solid #1a2530; vertical-align: middle; }
        tbody tr:hover td { background: rgba(11,110,79,0.06); }

        /* ── Badges ── */
        .badge { display: inline-block; padding: 2px 9px; border-radius: 999px; font-size: 11px; font-weight: 600; }
        .badge-active, .badge-validated { background: rgba(16,185,129,.15); color: #34d399; }
        .badge-pending { background: rgba(245,158,11,.15); color: #fbbf24; }
        .badge-expired, .badge-rejected { background: rgba(239,68,68,.15); color: #f87171; }
        .badge-suspended { background: rgba(139,92,246,.15); color: #a78bfa; }
        .badge-gray { background: rgba(255,255,255,.08); color: var(--gray-400); }

        /* ── Action buttons ── */
        .action-btns { display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-sm { padding: 4px 9px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; color: #fff; }
        .btn-green { background: #065f46; } .btn-green:hover { background: #047857; }
        .btn-blue { background: #1e40af; } .btn-blue:hover { background: #1d4ed8; }
        .btn-purple { background: #5b21b6; } .btn-purple:hover { background: #6d28d9; }
        .btn-red { background: #991b1b; } .btn-red:hover { background: #b91c1c; }

        /* ── Modal ── */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 16px; }
        .modal-box { background: var(--gray-800); border: 1px solid var(--gray-700); border-radius: 16px; padding: 24px; width: 100%; max-width: 440px; box-shadow: 0 25px 50px rgba(0,0,0,.5); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .modal-title { font-size: 16px; font-weight: 700; color: #fff; }
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-cancel { flex: 1; padding: 10px; background: var(--gray-700); color: var(--gray-200); border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn-confirm { flex: 1; padding: 10px; background: var(--green); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .modal-field { margin-bottom: 14px; }
        .modal-label { display: block; font-size: 12px; color: var(--gray-400); margin-bottom: 5px; }
        .modal-input { width: 100%; padding: 10px; background: var(--gray-700); border: 1px solid var(--gray-600); border-radius: 8px; color: #fff; font-size: 14px; outline: none; }
        .modal-input:focus { border-color: var(--green); }

        /* ── Toast ── */
        #toastContainer { position: fixed; top: 16px; right: 16px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
        .toast { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-radius: 10px; font-size: 13px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,.3); animation: slideIn .3s ease-out; }
        .toast-success { background: #064e3b; color: #6ee7b7; }
        .toast-error { background: #7f1d1d; color: #fca5a5; }
        @keyframes slideIn { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ── Spinner ── */
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,.2); border-top-color: #fff; border-radius: 50%; animation: spin .6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Mobile ── */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0 !important; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .page-content { padding: 12px; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
    <div class="login-card">
        <div class="login-logo"><i class="fas fa-shield-halved"></i></div>
        <div class="login-title">KABRAK Admin</div>
        <div class="login-sub">Panneau d'administration</div>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label class="form-label">Identifiant</label>
                <input type="text" id="loginUser" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" id="loginPass" class="form-input" required>
            </div>
            <button type="submit" id="loginBtn" class="btn-primary">Se connecter</button>
            <div id="loginError" class="login-error"></div>
        </form>
    </div>
</div>

<!-- Dashboard -->
<div id="dashboardScreen" style="display:none">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo-icon"><i class="fas fa-exchange-alt"></i></div>
            <span class="logo-text">KABRAK Admin</span>
        </div>
        <nav class="sidebar-nav">
            <button onclick="switchTab('dashboard')" class="nav-item active" data-tab="dashboard">
                <i class="fas fa-chart-pie"></i><span class="nav-label">Tableau de bord</span>
            </button>
            <button onclick="switchTab('licenses')" class="nav-item" data-tab="licenses">
                <i class="fas fa-key"></i><span class="nav-label">Licences</span>
            </button>
            <button onclick="switchTab('payments')" class="nav-item" data-tab="payments">
                <i class="fas fa-credit-card"></i><span class="nav-label">Paiements</span>
                <span id="pendingBadge" class="pending-badge">0</span>
            </button>
            <button onclick="switchTab('users')" class="nav-item" data-tab="users">
                <i class="fas fa-users"></i><span class="nav-label">Utilisateurs</span>
            </button>
        </nav>
        <div class="sidebar-footer">
            <div class="user-row">
                <div class="user-avatar"><i class="fas fa-user-shield"></i></div>
                <div class="user-info">
                    <span class="user-name">Admin</span>
                    <button onclick="handleLogout()" class="btn-logout">Déconnexion</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main id="mainContent" class="main-content">
        <div class="topbar">
            <div class="topbar-left">
                <button onclick="toggleSidebar()" class="btn-icon" id="menuToggle"><i class="fas fa-bars"></i></button>
                <h2 id="pageTitle">Tableau de bord</h2>
            </div>
            <div class="topbar-right">
                <button onclick="refreshData()" class="btn-icon" title="Rafraîchir"><i class="fas fa-sync-alt"></i></button>
                <span id="lastRefresh"></span>
            </div>
        </div>

        <div class="page-content">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Utilisateurs</span>
                            <i class="fas fa-users" style="color:#34d399"></i>
                        </div>
                        <div class="stat-value" id="statUsers">-</div>
                        <div class="stat-sub" id="statUsersActive">- actifs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Licences actives</span>
                            <i class="fas fa-key" style="color:#fbbf24"></i>
                        </div>
                        <div class="stat-value" id="statLicenses">-</div>
                        <div class="stat-sub" id="statLicensesTotal">/ - total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Paiements en attente</span>
                            <i class="fas fa-clock" style="color:#fb923c"></i>
                        </div>
                        <div class="stat-value orange" id="statPending">-</div>
                        <div class="stat-sub" id="statPaymentsTotal">/ - total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Expirent bientôt</span>
                            <i class="fas fa-exclamation-triangle" style="color:#f87171"></i>
                        </div>
                        <div class="stat-value red" id="statExpiring">-</div>
                        <div class="stat-sub">dans 7 jours</div>
                    </div>
                </div>

                <div class="two-col">
                    <div class="panel">
                        <div class="panel-title"><i class="fas fa-user-plus" style="color:#34d399"></i>Derniers inscrits</div>
                        <div id="recentUsersList"><div style="color:var(--gray-500);text-align:center;padding:16px;font-size:13px">Chargement...</div></div>
                    </div>
                    <div class="panel">
                        <div class="panel-title"><i class="fas fa-receipt" style="color:#fbbf24"></i>Derniers paiements</div>
                        <div id="recentPaymentsList"><div style="color:var(--gray-500);text-align:center;padding:16px;font-size:13px">Chargement...</div></div>
                    </div>
                </div>
            </div>

            <!-- Licenses Tab -->
            <div id="tab-licenses" class="tab-content">
                <div class="toolbar">
                    <button onclick="filterLicenses('')" class="filter-btn active license-filter">Toutes</button>
                    <button onclick="filterLicenses('active')" class="filter-btn license-filter">Actives</button>
                    <button onclick="filterLicenses('pending')" class="filter-btn license-filter">En attente</button>
                    <button onclick="filterLicenses('expired')" class="filter-btn license-filter">Expirées</button>
                    <input type="text" id="licenseSearch" placeholder="Rechercher..." oninput="renderLicenses()" class="search-input">
                    <button onclick="openCreateLicense()" class="btn-create">+ Nouvelle licence</button>
                </div>
                <div class="table-wrap">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>Entreprise</th><th>Email</th><th class="center">Plan</th>
                                    <th class="center">Statut</th><th class="center">Expiration</th><th class="center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="licensesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="tab-payments" class="tab-content">
                <div class="toolbar">
                    <button onclick="filterPayments('')" class="filter-btn active payment-filter">Tous</button>
                    <button onclick="filterPayments('pending')" class="filter-btn payment-filter">En attente</button>
                    <button onclick="filterPayments('validated')" class="filter-btn payment-filter">Validés</button>
                    <button onclick="filterPayments('rejected')" class="filter-btn payment-filter">Rejetés</button>
                </div>
                <div class="table-wrap"><div class="table-scroll">
                    <table>
                        <thead><tr>
                            <th>Utilisateur</th><th class="center">Plan</th><th class="center">Montant</th>
                            <th class="center">Méthode</th><th class="center">Référence</th>
                            <th class="center">Statut</th><th class="center">Date</th><th class="center">Actions</th>
                        </tr></thead>
                        <tbody id="paymentsTable"></tbody>
                    </table>
                </div></div>
            </div>

            <!-- Users Tab -->
            <div id="tab-users" class="tab-content">
                <div class="toolbar">
                    <input type="text" id="userSearch" placeholder="Rechercher par email ou nom..." oninput="renderUsers()" class="search-input" style="margin-left:0;width:280px">
                </div>
                <div class="table-wrap"><div class="table-scroll">
                    <table>
                        <thead><tr>
                            <th>Nom</th><th>Email</th><th>Entreprise</th>
                            <th class="center">Rôle</th><th class="center">Statut</th>
                            <th class="center">Dernière connexion</th><th class="center">Actions</th>
                        </tr></thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div></div>
            </div>
        </div>
    </main>
</div>

<!-- Action Modal -->
<div id="modal" style="display:none" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <span id="modalTitle" class="modal-title"></span>
            <button onclick="closeModal()" class="btn-icon"><i class="fas fa-times"></i></button>
        </div>
        <div id="modalBody"></div>
        <div class="modal-footer">
            <button onclick="closeModal()" class="btn-cancel">Annuler</button>
            <button id="modalConfirmBtn" class="btn-confirm">Confirmer</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toastContainer"></div>

<script>
const API = 'https://kabrak-exchange-pro-production.up.railway.app/api';
let token = localStorage.getItem('kabrak_admin_token');
let allLicenses = [], allPayments = [], allUsers = [];
let licenseFilter = '', paymentFilter = '';

// ─── Auth ───
if (token) showDashboard();

async function handleLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    btn.innerHTML = '<span class="spinner"></span>';
    btn.disabled = true;
    try {
        const res = await fetch(`${API}/admin/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: document.getElementById('loginUser').value, password: document.getElementById('loginPass').value })
        });
        const data = await res.json();
        if (res.ok && data.token) {
            token = data.token;
            localStorage.setItem('kabrak_admin_token', token);
            showDashboard();
        } else {
            document.getElementById('loginError').textContent = data.error || 'Identifiants invalides';
            document.getElementById('loginError').classList.remove('hidden');
        }
    } catch (err) {
        document.getElementById('loginError').textContent = 'Erreur réseau';
        document.getElementById('loginError').classList.remove('hidden');
    }
    btn.innerHTML = 'Se connecter';
    btn.disabled = false;
}

function handleLogout() {
    token = null;
    localStorage.removeItem('kabrak_admin_token');
    document.getElementById('dashboardScreen').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
}

function showDashboard() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboardScreen').classList.remove('hidden');
    refreshData();
}

// ─── API Helper ───
async function api(endpoint, opts = {}) {
    const res = await fetch(`${API}${endpoint}`, {
        ...opts,
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...opts.headers }
    });
    if (res.status === 401) { handleLogout(); throw new Error('Session expirée'); }
    return res;
}

// ─── Data Loading ───
async function refreshData() {
    document.getElementById('lastRefresh').textContent = 'Chargement...';
    const results = await Promise.allSettled([loadDashboard(), loadLicenses(), loadPayments(), loadUsers()]);
    const errors = results.filter(r => r.status === 'rejected');
    if (errors.length) { console.error('Erreurs chargement:', errors.map(e => e.reason)); }
    document.getElementById('lastRefresh').textContent = `Mis à jour: ${new Date().toLocaleTimeString('fr-FR')}`;
}

async function loadDashboard() {
    const res = await api('/admin/dashboard');
    const json = await res.json();
    if (!res.ok || !json.success) { console.error('Dashboard error:', json); throw new Error(json.error || 'Dashboard failed'); }
    const data = json.data;
    document.getElementById('statUsers').textContent = data.users?.total ?? 0;
    document.getElementById('statUsersActive').textContent = `${data.users?.active ?? 0} actifs`;
    document.getElementById('statLicenses').textContent = data.licenses?.active ?? 0;
    document.getElementById('statLicensesTotal').textContent = `/ ${data.licenses?.total ?? 0} total`;
    document.getElementById('statPending').textContent = data.payments?.pending ?? 0;
    document.getElementById('statPaymentsTotal').textContent = `/ ${data.payments?.total ?? 0} total`;
    document.getElementById('statExpiring').textContent = data.licenses?.expiringSoon ?? 0;

    // Pending badge
    const badge = document.getElementById('pendingBadge');
    const pendingCount = data.payments?.pending ?? 0;
    badge.textContent = pendingCount;
    badge.style.display = pendingCount > 0 ? 'inline-block' : 'none';

    // Recent users
    const ul = document.getElementById('recentUsersList');
    ul.innerHTML = (data.recentUsers || []).map(u => `
        <div class="activity-item">
            <div class="activity-avatar">${(u.firstName||'?')[0].toUpperCase()}</div>
            <div class="activity-info">
                <div class="activity-name">${u.firstName || ''} ${u.lastName || ''}</div>
                <div class="activity-meta">${u.email}</div>
            </div>
            <div class="activity-date">${fmtDate(u.createdAt)}</div>
        </div>
    `).join('') || '<div style="color:var(--gray-500);text-align:center;padding:16px;font-size:13px">Aucun inscrit récent</div>';

    // Recent payments
    const pl = document.getElementById('recentPaymentsList');
    pl.innerHTML = (data.recentPayments || []).map(p => {
        const av = p.status==='pending' ? 'background:#78350f;color:#fbbf24' : p.status==='validated' ? 'background:#064e3b;color:#34d399' : 'background:#7f1d1d;color:#f87171';
        const ic = p.status==='pending' ? 'fa-clock' : p.status==='validated' ? 'fa-check' : 'fa-times';
        return `<div class="activity-item">
            <div class="activity-avatar" style="${av}"><i class="fas ${ic}"></i></div>
            <div class="activity-info">
                <div class="activity-name">${p.user?.firstName||''} ${p.user?.lastName||''}</div>
                <div class="activity-meta">${p.plan||'-'} · ${fmtAmount(p.amount)} XOF</div>
            </div>
            <span class="badge badge-${p.status}">${statusLabel(p.status)}</span>
        </div>`;
    }).join('') || '<div style="color:var(--gray-500);text-align:center;padding:16px;font-size:13px">Aucun paiement récent</div>';
}

async function loadLicenses() {
    const res = await api('/admin/licenses');
    const data = await res.json();
    allLicenses = data.data || data || [];
    renderLicenses();
}

async function loadPayments() {
    const res = await api('/admin/payments');
    const data = await res.json();
    allPayments = data.data || [];
    renderPayments();
}

async function loadUsers() {
    const res = await api('/admin/users');
    const data = await res.json();
    allUsers = data.data || [];
    renderUsers();
}

// ─── Render Functions ───
function renderLicenses() {
    const search = (document.getElementById('licenseSearch')?.value || '').toLowerCase();
    const filtered = allLicenses.filter(l => {
        if (licenseFilter && l.status !== licenseFilter) return false;
        if (search && !(l.businessName||'').toLowerCase().includes(search) && !(l.ownerEmail||'').toLowerCase().includes(search)) return false;
        return true;
    });
    const tbody = document.getElementById('licensesTable');
    tbody.innerHTML = filtered.map(l => {
        const now = new Date();
        const isExpired = l.status === 'active' && l.expiresAt && new Date(l.expiresAt) < now;
        const displayStatus = isExpired ? 'expired' : l.status;
        const daysLeft = l.expiresAt ? Math.ceil((new Date(l.expiresAt) - now) / 86400000) : 0;
        return `<tr>
            <td style="font-weight:600">${l.businessName || '-'}</td>
            <td style="color:var(--gray-400)">${l.ownerEmail || '-'}</td>
            <td class="center"><span class="badge badge-gray">${(l.plan||'trial').toUpperCase()}</span></td>
            <td class="center"><span class="badge badge-${displayStatus}">${statusLabel(displayStatus)}</span></td>
            <td class="center" style="font-size:12px">${l.expiresAt ? fmtDate(l.expiresAt) : '-'}${daysLeft > 0 && daysLeft < 30 ? ` <span style="color:#fb923c">(${daysLeft}j)</span>` : ''}</td>
            <td class="center">
                <div class="action-btns">
                    ${l.status === 'pending' ? `<button onclick="approveLicense('${l.id}')" class="btn-sm btn-green" title="Approuver"><i class="fas fa-check"></i></button>` : ''}
                    <button onclick="extendLicense('${l.id}')" class="btn-sm btn-blue" title="Étendre"><i class="fas fa-calendar-plus"></i></button>
                    <button onclick="changePlan('${l.id}')" class="btn-sm btn-purple" title="Plan"><i class="fas fa-arrow-up"></i></button>
                </div>
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="6" style="text-align:center;padding:32px;color:var(--gray-500)">Aucune licence trouvée</td></tr>';
}

function renderPayments() {
    const filtered = allPayments.filter(p => !paymentFilter || p.status === paymentFilter);
    const tbody = document.getElementById('paymentsTable');
    tbody.innerHTML = filtered.map(p => `
        <tr>
            <td>
                <div style="font-weight:600">${p.user?.firstName || ''} ${p.user?.lastName || ''}</div>
                <div style="font-size:11px;color:var(--gray-500)">${p.user?.email || '-'}</div>
            </td>
            <td class="center"><span class="badge badge-gray">${(p.plan||'-').toUpperCase()}</span></td>
            <td class="center" style="font-weight:600">${fmtAmount(p.amount)} XOF</td>
            <td class="center" style="font-size:12px">${p.method || '-'}</td>
            <td class="center" style="font-size:11px;font-family:monospace">${p.reference || '-'}</td>
            <td class="center"><span class="badge badge-${p.status}">${statusLabel(p.status)}</span></td>
            <td class="center" style="font-size:12px">${fmtDate(p.createdAt)}</td>
            <td class="center">
                ${p.status === 'pending' ? `
                    <div class="action-btns">
                        <button onclick="validatePayment('${p.id}')" class="btn-sm btn-green" title="Valider"><i class="fas fa-check"></i></button>
                        <button onclick="rejectPayment('${p.id}')" class="btn-sm btn-red" title="Rejeter"><i class="fas fa-times"></i></button>
                    </div>
                ` : '<span style="color:var(--gray-500)">-</span>'}
            </td>
        </tr>
    `).join('') || '<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--gray-500)">Aucun paiement trouvé</td></tr>';
}

function renderUsers() {
    const search = (document.getElementById('userSearch')?.value || '').toLowerCase();
    const filtered = allUsers.filter(u => {
        if (!search) return true;
        return (u.email||'').toLowerCase().includes(search) || (u.firstName||'').toLowerCase().includes(search) || (u.lastName||'').toLowerCase().includes(search) || (u.businessName||'').toLowerCase().includes(search);
    });
    const tbody = document.getElementById('usersTable');
    tbody.innerHTML = filtered.map(u => `
        <tr>
            <td style="font-weight:600">${u.firstName || ''} ${u.lastName || ''}</td>
            <td style="color:var(--gray-400)">${u.email}</td>
            <td>${u.businessName || '-'}</td>
            <td class="center"><span class="badge badge-gray">${u.teamRole || u.role || '-'}</span></td>
            <td class="center"><span class="badge ${u.isActive ? 'badge-active' : 'badge-expired'}">${u.isActive ? 'Actif' : 'Inactif'}</span></td>
            <td class="center" style="font-size:12px">${u.lastLogin ? fmtDate(u.lastLogin) : 'Jamais'}</td>
            <td class="center">
                <button onclick="toggleUser('${u.id}', ${u.isActive})" class="btn-sm ${u.isActive ? 'btn-red' : 'btn-green'}">
                    <i class="fas ${u.isActive ? 'fa-ban' : 'fa-check'}"></i>
                </button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--gray-500)">Aucun utilisateur trouvé</td></tr>';
}

// ─── Tab Navigation ───
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    const titles = { dashboard: 'Tableau de bord', licenses: 'Licences', payments: 'Paiements', users: 'Utilisateurs' };
    document.getElementById('pageTitle').textContent = titles[tab] || tab;
    document.getElementById('sidebar').classList.remove('mobile-open');
}

function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    if (window.innerWidth < 768) { sb.classList.toggle('mobile-open'); }
    else {
        sb.classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('expanded');
    }
}

// ─── Filters ───
function filterLicenses(status) {
    licenseFilter = status;
    document.querySelectorAll('.license-filter').forEach(b => b.classList.remove('active'));
    if (event?.target) event.target.classList.add('active');
    renderLicenses();
}
function filterPayments(status) {
    paymentFilter = status;
    document.querySelectorAll('.payment-filter').forEach(b => b.classList.remove('active'));
    if (event?.target) event.target.classList.add('active');
    renderPayments();
}

// ─── License Actions ───
function approveLicense(id) {
    openModal('Approuver la licence', `
        <div class="modal-field"><label class="modal-label">Durée :</label>
        <select id="mDays" class="modal-input">
            <option value="30">30 jours (1 mois)</option>
            <option value="90" selected>90 jours (3 mois)</option>
            <option value="180">180 jours (6 mois)</option>
            <option value="365">365 jours (1 an)</option>
        </select></div>
    `, async () => {
        const days = document.getElementById('mDays').value;
        await api(`/admin/licenses/${id}/approve`, { method: 'POST', body: JSON.stringify({ days: +days }) });
        toast('Licence approuvée', 'success');
        closeModal(); refreshData();
    });
}

function extendLicense(id) {
    openModal('Étendre la licence', `
        <div class="modal-field"><label class="modal-label">Ajouter :</label>
        <select id="mDays" class="modal-input">
            <option value="7">7 jours</option>
            <option value="30" selected>30 jours</option>
            <option value="90">90 jours</option>
            <option value="365">1 an</option>
        </select></div>
    `, async () => {
        const days = document.getElementById('mDays').value;
        await api(`/admin/licenses/${id}/extend`, { method: 'POST', body: JSON.stringify({ days: +days }) });
        toast('Licence étendue', 'success');
        closeModal(); refreshData();
    });
}

function changePlan(id) {
    openModal('Changer le plan', `
        <div class="modal-field"><label class="modal-label">Nouveau plan :</label>
        <select id="mPlan" class="modal-input">
            <option value="trial">Trial</option>
            <option value="basic">Basic</option>
            <option value="pro">Pro</option>
            <option value="premium">Premium</option>
        </select></div>
    `, async () => {
        const plan = document.getElementById('mPlan').value;
        await api(`/admin/licenses/${id}/plan`, { method: 'POST', body: JSON.stringify({ plan }) });
        toast('Plan modifié', 'success');
        closeModal(); refreshData();
    });
}

// ─── Payment Actions ───
async function validatePayment(id) {
    if (!confirm('Valider ce paiement et activer la licence ?')) return;
    try {
        await api(`/payments/${id}/validate`, { method: 'POST' });
        toast('Paiement validé, licence activée', 'success');
        refreshData();
    } catch (e) { toast('Erreur de validation', 'error'); }
}

async function rejectPayment(id) {
    if (!confirm('Rejeter ce paiement ?')) return;
    try {
        await api(`/payments/${id}/reject`, { method: 'POST', body: JSON.stringify({ reason: 'Rejeté par admin' }) });
        toast('Paiement rejeté', 'error');
        refreshData();
    } catch (e) { toast('Erreur', 'error'); }
}

// ─── User Actions ───
async function toggleUser(id, isActive) {
    if (!confirm(`${isActive ? 'Désactiver' : 'Activer'} cet utilisateur ?`)) return;
    try {
        await api(`/admin/users/${id}/toggle`, { method: 'PUT' });
        toast(`Utilisateur ${isActive ? 'désactivé' : 'activé'}`, 'success');
        refreshData();
    } catch (e) { toast('Erreur', 'error'); }
}

// ─── Modal ───
function openModal(title, body, onConfirm) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modalConfirmBtn').onclick = async () => {
        try { await onConfirm(); } catch (e) { toast(e.message || 'Erreur', 'error'); }
    };
    document.getElementById('modal').style.display = 'flex';
}
function closeModal() { document.getElementById('modal').style.display = 'none'; }

// ─── Toast ───
function toast(msg, type = 'success') {
    const c = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
    t.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>${msg}`;
    c.appendChild(t);
    setTimeout(() => { t.remove(); }, 3500);
}

// ─── Helpers ───
function fmtDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }) : '-'; }
function fmtAmount(a) { return parseFloat(a || 0).toLocaleString('fr-FR'); }
function statusLabel(s) {
    const map = { active: 'Actif', pending: 'Attente', expired: 'Expiré', validated: 'Validé', rejected: 'Rejeté', trial: 'Essai', suspended: 'Suspendu', monthly: 'Mensuel', annual: 'Annuel' };
    return map[s] || s || '-';
}

// ─── Renew License ───
function renewLicense(id, plan) {
    const days = plan === 'annual' ? 365 : 30;
    openModal(`Renouveler (${plan === 'annual' ? '1 an' : '1 mois'})`, `
        <p style="color:var(--gray-400);font-size:13px;margin-bottom:12px">Ajouter <strong style="color:#fff">${days} jours</strong> à cette licence ?</p>
        <div class="modal-field"><label class="modal-label">Ou choisir une durée :</label>
        <select id="mDays" class="modal-input">
            <option value="30" ${plan==='monthly'?'selected':''}>30 jours (1 mois)</option>
            <option value="90">90 jours (3 mois)</option>
            <option value="180">180 jours (6 mois)</option>
            <option value="365" ${plan==='annual'?'selected':''}>365 jours (1 an)</option>
        </select></div>
    `, async () => {
        const d = document.getElementById('mDays').value;
        await api(`/admin/licenses/${id}/extend`, { method: 'POST', body: JSON.stringify({ days: +d }) });
        toast('Licence renouvelée ✅', 'success');
        closeModal(); refreshData();
    });
}

// ─── Create License ───
function openCreateLicense() {
    openModal('Nouvelle licence', `
        <div class="modal-field"><label class="modal-label">Bureau de change *</label><input id="nBusiness" class="modal-input" placeholder="Ex: Exchange Dakar" /></div>
        <div class="modal-field"><label class="modal-label">Nom propriétaire *</label><input id="nOwner" class="modal-input" placeholder="Prénom Nom" /></div>
        <div class="modal-field"><label class="modal-label">Email *</label><input id="nEmail" type="email" class="modal-input" placeholder="email@exemple.com" /></div>
        <div class="modal-field"><label class="modal-label">Téléphone</label><input id="nPhone" class="modal-input" placeholder="+221..." /></div>
        <div class="modal-field"><label class="modal-label">Plan</label>
            <select id="nPlan" class="modal-input">
                <option value="trial">Essai 14 jours</option>
                <option value="monthly">Mensuel (30 jours)</option>
                <option value="annual">Annuel (1 an)</option>
            </select>
        </div>
    `, async () => {
        const b = document.getElementById('nBusiness').value.trim();
        const o = document.getElementById('nOwner').value.trim();
        const e = document.getElementById('nEmail').value.trim();
        const ph = document.getElementById('nPhone').value.trim();
        const pl = document.getElementById('nPlan').value;
        if (!b || !o || !e) { toast('Champs obligatoires manquants', 'error'); return; }
        const res = await api('/licenses', { method: 'POST', body: JSON.stringify({ businessName: b, ownerName: o, ownerEmail: e, ownerPhone: ph, plan: pl }) });
        const d = await res.json();
        if (d.success) {
            toast(`Licence créée — Clé: ${d.data.licenseKey}`, 'success');
            prompt('Copiez la clé de licence :', d.data.licenseKey);
            closeModal(); refreshData();
        } else { toast(d.message || 'Erreur', 'error'); }
    });
}
</script>
</body>
</html>
